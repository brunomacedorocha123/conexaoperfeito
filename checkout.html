<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Amor Conect</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Mantenha o CSS original do checkout */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        :root { --bege: #f6ecc5; --vermelho-rosado: #d1656d; --lilas: #dfc9ed; --branco: #ffffff; --text: #444; }
        body { background-color: var(--bege); color: var(--text); display: flex; flex-direction: column; min-height: 100vh; align-items: center; justify-content: center; padding: 2rem; }
        .checkout-card { background: var(--branco); border-radius: 20px; padding: 3rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 500px; width: 100%; text-align: center; }
        .btn { padding: 1rem 2rem; border-radius: 30px; border: none; font-weight: 600; cursor: pointer; margin: 0.5rem; transition: all 0.3s ease; background: var(--vermelho-rosado); color: var(--branco); text-decoration: none; display: inline-block; }
        .btn:hover { transform: translateY(-2px); }
    </style>
</head>
<body>
    <div class="checkout-card">
        <div style="font-size: 4rem; margin-bottom: 1rem;">üíé</div>
        <h1 style="color: var(--vermelho-rosado); margin-bottom: 1rem;">Checkout Simplificado</h1>
        <p style="margin-bottom: 2rem; font-size: 1.1rem;">
            Clique no bot√£o abaixo para <strong>ativar instantaneamente</strong> seu Premium!
        </p>
        
        <button class="btn" onclick="activatePremium()" style="font-size: 1.2rem; padding: 1.2rem 2.5rem;">
            ‚úÖ ATIVAR PREMIUM AGORA
        </button>
        
        <div id="loading" style="display: none; margin: 2rem 0;">
            <div style="border: 4px solid var(--bege); border-top: 4px solid var(--vermelho-rosado); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 1rem;"></div>
            <p>Ativando seu Premium...</p>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://gcukalndarlgydmgmmmt.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjdWthbG5kYXJsZ3lkbWdtbW10Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NzI1ODEsImV4cCI6MjA3NTI0ODU4MX0.S1Qt1UbmK-Jtq2dX7Aarf2rDLZhoLgEcSLkCrBfIhUU';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function activatePremium() {
            const loading = document.getElementById('loading');
            const button = document.querySelector('.btn');
            
            button.style.display = 'none';
            loading.style.display = 'block';

            try {
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    alert('‚ö†Ô∏è Fa√ßa login primeiro');
                    return;
                }

                console.log('üéØ Ativando premium para:', user.id);

                // ‚úÖ CHAMAR A FUN√á√ÉO RPC QUE CRIAMOS
                const { data: subscriptionId, error } = await supabase
                    .rpc('create_user_subscription', {
                        p_user_id: user.id,
                        p_plan_name: 'monthly',
                        p_payment_method: 'credit_card',
                        p_gateway: 'mercadopago',
                        p_gateway_transaction_id: 'mp_' + Date.now()
                    });

                if (error) {
                    console.error('‚ùå Erro:', error);
                    alert('‚ùå Erro ao ativar. Tente novamente.');
                    button.style.display = 'inline-block';
                    loading.style.display = 'none';
                    return;
                }

                console.log('‚úÖ Premium ativado! ID:', subscriptionId);
                
                // ‚úÖ REDIRECIONAR PARA MENSAGENS COM PAR√ÇMETRO
                setTimeout(() => {
                    window.location.href = `mensagens.html?premium=activated&t=${Date.now()}`;
                }, 2000);

            } catch (error) {
                console.error('‚ùå Erro geral:', error);
                alert('‚ùå Erro inesperado.');
                button.style.display = 'inline-block';
                loading.style.display = 'none';
            }
        }

        // Estilo da anima√ß√£o
        const style = document.createElement('style');
        style.textContent = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
        document.head.appendChild(style);
    </script>
</body>
</html>