<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minha Lista VIP - Amor Conect</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="home.css">
  <link rel="stylesheet" href="home-mobile.css">
  <style>
    /* ==================== ESTILOS ESPEC√çFICOS DA LISTA VIP ==================== */
    .vip-hero {
      text-align: center;
      margin-bottom: 2rem;
      padding: 2.5rem;
      background: linear-gradient(135deg, #fff9c4, #ffecb3);
      border-radius: 20px;
      border: 3px solid #ffd700;
      box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
      position: relative;
      overflow: hidden;
    }

    .vip-hero::before {
      content: "‚≠ê";
      position: absolute;
      top: -20px;
      right: -20px;
      font-size: 8rem;
      opacity: 0.1;
      transform: rotate(15deg);
    }

    .vip-hero h1 {
      font-size: 2.5rem;
      color: #b8860b;
      margin-bottom: 0.5rem;
      font-weight: 800;
    }

    .vip-hero p {
      font-size: 1.2rem;
      color: #d4af37;
      margin-bottom: 1.5rem;
    }

    .vip-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .vip-stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      border: 2px solid #ffd700;
      transition: all 0.3s ease;
    }

    .vip-stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(255, 215, 0, 0.2);
    }

    .vip-stat-number {
      font-size: 2.2rem;
      font-weight: 800;
      color: #b8860b;
      margin-bottom: 0.5rem;
    }

    .vip-stat-label {
      font-size: 0.9rem;
      color: var(--text-light);
      font-weight: 600;
    }

    /* ==================== SISTEMA DE FILTROS E BUSCA ==================== */
    .vip-controls {
      background: white;
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      border: 2px solid var(--lilas);
    }

    .search-box {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      align-items: center;
    }

    .search-input {
      flex: 1;
      padding: 1rem 1.5rem;
      border: 2px solid var(--lilas);
      border-radius: 50px;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--vermelho-rosado);
      box-shadow: 0 0 0 3px rgba(209, 101, 109, 0.1);
    }

    .search-btn {
      padding: 1rem 1.5rem;
      background: linear-gradient(135deg, var(--vermelho-rosado), var(--lilas));
      color: white;
      border: none;
      border-radius: 50px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .search-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(209, 101, 109, 0.4);
    }

    .vip-filters {
      display: flex;
      gap: 0.8rem;
      flex-wrap: wrap;
      align-items: center;
    }

    .filter-btn {
      padding: 0.8rem 1.2rem;
      background: var(--bege);
      border: 2px solid var(--lilas);
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
    }

    .filter-btn:hover {
      background: var(--lilas);
      color: white;
      transform: translateY(-2px);
    }

    .filter-btn.active {
      background: linear-gradient(135deg, var(--vermelho-rosado), var(--lilas));
      color: white;
      border-color: var(--vermelho-rosado);
    }

    .filter-count {
      background: white;
      color: var(--vermelho-rosado);
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 800;
    }

    /* ==================== CARDS VIP ==================== */
    .vip-users-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-bottom: 3rem;
    }

    .vip-user-card {
      background: white;
      border-radius: 20px;
      padding: 1.5rem;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .vip-user-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.15);
      border-color: #ffd700;
    }

    .vip-user-card.mutual-match {
      border-color: #ff6b6b;
      background: linear-gradient(135deg, #fff, #fff5f5);
    }

    .vip-user-card.mutual-match::before {
      content: "üíù Match!";
      position: absolute;
      top: 10px;
      right: 10px;
      background: linear-gradient(135deg, #ff6b6b, #ee5a52);
      color: white;
      padding: 0.3rem 0.8rem;
      border-radius: 15px;
      font-size: 0.7rem;
      font-weight: 700;
      z-index: 2;
    }

    .vip-user-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .vip-user-avatar {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      position: relative;
      flex-shrink: 0;
    }

    .vip-user-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
      border: 3px solid #ffd700;
    }

    .vip-user-info {
      flex: 1;
    }

    .vip-user-name {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 0.3rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .vip-user-details {
      font-size: 0.9rem;
      color: var(--text-light);
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }

    .vip-user-bio {
      font-size: 0.9rem;
      color: var(--text);
      margin-bottom: 1.5rem;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .vip-user-actions {
      display: flex;
      gap: 0.8rem;
      justify-content: space-between;
    }

    .vip-action-btn {
      flex: 1;
      padding: 0.8rem;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      font-size: 0.85rem;
    }

    .vip-action-btn.primary {
      background: linear-gradient(135deg, var(--vermelho-rosado), var(--lilas));
      color: white;
    }

    .vip-action-btn.secondary {
      background: var(--bege);
      color: var(--text);
      border: 2px solid var(--lilas);
    }

    .vip-action-btn.danger {
      background: #fed7d7;
      color: #e53e3e;
      border: 2px solid #feb2b2;
    }

    .vip-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* ==================== ESTADOS VAZIOS ==================== */
    .vip-empty-state {
      text-align: center;
      padding: 4rem 2rem;
      background: white;
      border-radius: 20px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
      border: 2px dashed var(--lilas);
    }

    .vip-empty-icon {
      font-size: 4rem;
      margin-bottom: 1.5rem;
      opacity: 0.7;
    }

    .vip-empty-title {
      font-size: 1.5rem;
      color: var(--vermelho-rosado);
      margin-bottom: 1rem;
      font-weight: 700;
    }

    .vip-empty-description {
      color: var(--text-light);
      margin-bottom: 2rem;
      font-size: 1rem;
    }

    /* ==================== LOADING ==================== */
    .vip-loading {
      text-align: center;
      padding: 3rem;
    }

    .vip-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--bege);
      border-top: 4px solid #ffd700;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }

    /* ==================== RESPONSIVIDADE ESPEC√çFICA ==================== */
    @media (max-width: 768px) {
      .vip-hero {
        padding: 2rem 1.5rem;
      }

      .vip-hero h1 {
        font-size: 2rem;
      }

      .vip-stats {
        grid-template-columns: repeat(2, 1fr);
      }

      .vip-users-grid {
        grid-template-columns: 1fr;
      }

      .search-box {
        flex-direction: column;
      }

      .search-input {
        width: 100%;
      }

      .vip-filters {
        justify-content: center;
      }

      .vip-user-actions {
        flex-direction: column;
      }

      .vip-user-header {
        flex-direction: column;
        text-align: center;
      }

      .vip-user-avatar {
        width: 80px;
        height: 80px;
      }
    }

    @media (max-width: 480px) {
      .vip-stats {
        grid-template-columns: 1fr;
      }

      .vip-stat-card {
        padding: 1.2rem;
      }

      .vip-hero {
        padding: 1.5rem;
      }

      .vip-hero h1 {
        font-size: 1.7rem;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container">
      <div class="header-content">
        <button id="hamburgerBtn">‚ò∞</button>
        <div class="logo">
          <img src="logoamorconect.png" alt="Amor Conect">
        </div>
        
        <!-- üîî SINO DE NOTIFICA√á√ïES -->
        <div class="notification-bell-container">
          <a href="notificacoes.html" class="notification-bell" id="notificationBell" title="Notifica√ß√µes">
            üîî
            <span class="notification-badge" id="notificationBadge">0</span>
          </a>
        </div>

        <div class="user-menu">
          <div class="user-info">
            <div class="user-avatar" id="userAvatar">
              <img class="user-avatar-img" src="" alt="Avatar" style="display: none;">
              <div class="user-avatar-fallback">U</div>
            </div>
            <span id="userNickname">Usu√°rio</span>
          </div>
          <!-- Badge Free e Bot√£o Premium -->
          <div id="freeBadge" class="free-badge" style="display: none;">Free</div>
          <a href="princing.html" id="premiumBtn" class="btn btn-premium" style="display: none;">Premium</a>
          <a href="home.html" class="btn btn-outline">üè† Home</a>
          <a href="mensagens.html" class="btn btn-outline">üíå Mensagens</a>
          <a href="busca.html" class="btn btn-outline">üîç Buscar</a>
          <button class="btn btn-outline" id="logoutBtn">Sair</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Menu Mobile -->
  <div id="mobileMenu">
    <button id="closeMobileMenu">√ó</button>
    
    <div class="mobile-user-info">
      <div class="user-avatar" id="mobileUserAvatar">
        <img class="user-avatar-img" src="" alt="Avatar" style="display: none;">
        <div class="user-avatar-fallback">U</div>
      </div>
      <div id="mobileUserNickname">Usu√°rio</div>
    </div>

    <div class="mobile-nav">
      <!-- SINO DE NOTIFICA√á√ïES MOBILE -->
      <a href="notificacoes.html" class="btn btn-outline notification-mobile-btn">
        üîî Notifica√ß√µes
        <span class="notification-badge" id="mobileNotificationBadge">0</span>
      </a>
      
      <!-- Badge Free e Bot√£o Premium Mobile -->
      <div id="mobileFreeBadge" class="free-badge" style="display: none;">Free</div>
      <a href="princing.html" id="mobilePremiumBtn" class="btn btn-premium" style="display: none;">Premium</a>
      <a href="home.html" class="btn btn-outline">üè† Home</a>
      <a href="busca.html" class="btn btn-outline">üîç Buscar</a>
      <a href="mensagens.html" class="btn btn-outline">üíå Mensagens</a>
      <button class="btn btn-outline" id="mobileLogoutBtn">Sair</button>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main-content">
    <div class="container">
      <!-- Hero Section VIP -->
      <section class="vip-hero">
        <h1>‚≠ê Minha Lista VIP</h1>
        <p>Seus favoritos e matches especiais em um s√≥ lugar!</p>
        <div class="vip-stats">
          <div class="vip-stat-card">
            <div class="vip-stat-number" id="totalFavorites">0</div>
            <div class="vip-stat-label">Total de Favoritos</div>
          </div>
          <div class="vip-stat-card">
            <div class="vip-stat-number" id="mutualMatches">0</div>
            <div class="vip-stat-label">Matches M√∫tuos</div>
          </div>
          <div class="vip-stat-card">
            <div class="vip-stat-number" id="onlineNow">0</div>
            <div class="vip-stat-label">Online Agora</div>
          </div>
        </div>
      </section>

      <!-- Sistema de Filtros e Busca -->
      <section class="vip-controls">
        <div class="search-box">
          <input type="text" class="search-input" id="vipSearch" placeholder="üîç Buscar na sua lista VIP...">
          <button class="search-btn" id="clearSearch">Limpar</button>
        </div>
        
        <div class="vip-filters">
          <button class="filter-btn active" data-filter="all">
            ‚≠ê Todos
            <span class="filter-count" id="countAll">0</span>
          </button>
          <button class="filter-btn" data-filter="mutual">
            üíù Matches
            <span class="filter-count" id="countMutual">0</span>
          </button>
          <button class="filter-btn" data-filter="online">
            üü¢ Online
            <span class="filter-count" id="countOnline">0</span>
          </button>
          <button class="filter-btn" data-filter="recent">
            üìÖ Recentes
            <span class="filter-count" id="countRecent">0</span>
          </button>
        </div>
      </section>

      <!-- Grid de Usu√°rios VIP -->
      <section class="vip-users-section">
        <div class="vip-users-grid" id="vipUsersGrid">
          <div class="vip-loading">
            <div class="vip-spinner"></div>
            <p>Carregando sua lista VIP...</p>
          </div>
        </div>
      </section>

      <!-- A√ß√£o de Voltar -->
      <section class="quick-actions">
        <div class="actions-grid">
          <a href="home.html" class="action-card">
            <div class="action-icon">üè†</div>
            <h3>Voltar para Home</h3>
            <p>Retornar √† p√°gina principal</p>
          </a>
          <a href="busca.html" class="action-card">
            <div class="action-icon">üîç</div>
            <h3>Buscar Novas Pessoas</h3>
            <p>Encontre mais perfis interessantes</p>
          </a>
          <a href="princing.html" class="action-card vip-action-card">
            <div class="action-icon">üíé</div>
            <h3>Recursos Premium</h3>
            <p>Desbloqueie funcionalidades exclusivas</p>
          </a>
        </div>
      </section>
    </div>
  </main>

  <!-- Modal de Confirma√ß√£o de Remo√ß√£o -->
  <div class="modal-overlay" id="removeFavoriteModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚ùå Remover dos Favoritos</h3>
        <button class="close-modal" onclick="closeRemoveFavoriteModal()">√ó</button>
      </div>
      
      <div class="modal-body">
        <p>Tem certeza que deseja remover <strong id="removeUserName">Usu√°rio</strong> da sua Lista VIP?</p>
        <p style="color: var(--text-light); font-size: 0.9rem; margin-top: 1rem;">
          ‚ö†Ô∏è Esta a√ß√£o pode ser revertida curtindo o perfil novamente.
        </p>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeRemoveFavoriteModal()">Cancelar</button>
        <button class="btn btn-primary" onclick="confirmRemoveFavorite()" id="confirmRemoveBtn">
          Sim, Remover
        </button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-column">
          <h3>Amor Conect</h3>
          <p>Uma plataforma segura e discreta para conectar cora√ß√µes e construir relacionamentos genu√≠nos.</p>
        </div>
        <div class="footer-column">
          <h3>Links R√°pidos</h3>
          <ul>
            <li><a href="home.html">P√°gina Inicial</a></li>
            <li><a href="princing.html">Planos Premium</a></li>
            <li><a href="busca.html">Buscar Pessoas</a></li>
            <li><a href="lista-vip.html">Minha Lista VIP</a></li>
          </ul>
        </div>
        <div class="footer-column">
          <h3>Suporte</h3>
          <ul>
            <li><a href="#">Central de Ajuda</a></li>
            <li><a href="#">Pol√≠tica de Privacidade</a></li>
            <li><a href="#">Termos de Uso</a></li>
            <li><a href="#" onclick="openSupportModal()">üö® Reportar Problema</a></li>
          </ul>
        </div>
      </div>
      <div class="copyright">
        <p>&copy; 2024 Amor Conect. Todos os direitos reservados.</p>
      </div>
    </div>
  </footer>

  <script>
// ==================== CONFIGURA√á√ÉO SUPABASE ====================
const supabaseUrl = 'https://gcukalndarlgydmgmmmt.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjdWthbG5kYXJsZ3lkbWdtbW10Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk2NzI1ODEsImV4cCI6MjA3NTI0ODU4MX0.S1Qt1UbmK-Jtq2dX7Aarf2rDLZhoLgEcSLkCrBfIhUU';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// ==================== VARI√ÅVEIS GLOBAIS ====================
let currentUser = null;
let userProfile = null;
let vipUsers = [];
let filteredUsers = [];
let currentRemoveUserId = null;
let currentRemoveUserName = null;

// ==================== INICIALIZA√á√ÉO PRINCIPAL ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Iniciando Lista VIP...');
    initializeVipPage();
});

async function initializeVipPage() {
    try {
        // 1. Verificar autentica√ß√£o
        const { data: { user }, error } = await supabase.auth.getUser();
        
        if (error || !user) {
            console.error('‚ùå Usu√°rio n√£o autenticado:', error);
            window.location.href = 'login.html';
            return;
        }
        
        console.log('‚úÖ Usu√°rio autenticado:', user.id);
        currentUser = user;
        
        // 2. Carregar dados do usu√°rio
        await loadUserData();
        
        // 3. Verificar se √© Premium
        if (!userProfile?.is_premium) {
            showPremiumRequiredModal();
            return;
        }
        
        // 4. Carregar lista VIP
        await loadVipUsers();
        
        // 5. Configurar UI
        setupEventListeners();
        setupMobileMenu();
        
        console.log('üéØ Lista VIP carregada com sucesso!');
        
    } catch (error) {
        console.error('‚ùå Erro cr√≠tico na inicializa√ß√£o:', error);
        showQuickToast('Erro ao carregar a Lista VIP. Recarregue.');
    }
}

// ==================== CARREGAR DADOS DO USU√ÅRIO ====================
async function loadUserData() {
    try {
        const { data: profile, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', currentUser.id)
            .single();

        if (error) throw error;

        userProfile = profile;

        let displayName = 'Usu√°rio';
        
        if (currentUser.user_metadata?.nickname) {
            displayName = currentUser.user_metadata.nickname;
        } else if (currentUser.user_metadata?.full_name) {
            displayName = currentUser.user_metadata.full_name;
        } else if (currentUser.email) {
            displayName = currentUser.email.split('@')[0];
        }

        // Atualizar elementos da UI
        const nicknameElements = [
            document.getElementById('userNickname'),
            document.getElementById('mobileUserNickname')
        ];
        
        nicknameElements.forEach(element => {
            if (element) element.textContent = displayName;
        });

        // Atualizar avatar
        await updateUserAvatar(displayName, profile);
        
    } catch (error) {
        console.error('Erro ao carregar dados do usu√°rio:', error);
    }
}

async function updateUserAvatar(displayName, profile) {
    const avatarElements = [
        document.getElementById('userAvatar'),
        document.getElementById('mobileUserAvatar')
    ];

    for (const avatarElement of avatarElements) {
        if (!avatarElement) continue;
        
        const fallback = avatarElement.querySelector('.user-avatar-fallback');
        const img = avatarElement.querySelector('.user-avatar-img');
        
        if (!fallback || !img) continue;

        img.style.display = 'none';
        fallback.style.display = 'flex';
        
        if (profile?.avatar_url) {
            const photoUrl = await loadUserPhoto(profile.avatar_url);
            if (photoUrl) {
                img.src = photoUrl;
                img.style.display = 'block';
                fallback.style.display = 'none';
            }
        }
        
        fallback.textContent = displayName.charAt(0).toUpperCase();
    }
}

async function loadUserPhoto(avatarUrl) {
    try {
        if (!avatarUrl) return null;
        const { data } = supabase.storage.from('avatars').getPublicUrl(avatarUrl);
        return data?.publicUrl || null;
    } catch (error) {
        return null;
    }
}

// ==================== SISTEMA DE LISTA VIP ====================
async function loadVipUsers() {
    try {
        console.log('‚≠ê Carregando lista VIP...');
        
        const { data: favorites, error } = await supabase
            .from('user_favorites')
            .select(`
                favorite_user_id,
                created_at,
                profiles:user_favorites_favorite_user_id_fkey (
                    id,
                    nickname,
                    full_name,
                    avatar_url,
                    birth_date,
                    city,
                    last_online_at,
                    is_invisible,
                    user_details (
                        zodiac,
                        profession,
                        description
                    )
                )
            `)
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });

        if (error) {
            console.error('‚ùå Erro ao carregar favoritos:', error);
            showEmptyState('Erro ao carregar sua lista VIP.');
            return;
        }

        if (!favorites || favorites.length === 0) {
            showEmptyState();
            return;
        }

        console.log(`‚úÖ ${favorites.length} favoritos encontrados`);

        // Processar usu√°rios e verificar matches m√∫tuos
        vipUsers = await Promise.all(
            favorites.map(async (favorite) => {
                const user = favorite.profiles;
                const isMutual = await checkMutualLike(user.id);
                const isOnline = checkUserOnline(user);
                
                return {
                    id: user.id,
                    nickname: user.nickname || user.full_name?.split(' ')[0] || 'Usu√°rio',
                    avatar_url: user.avatar_url,
                    age: user.birth_date ? calculateAge(user.birth_date) : null,
                    city: user.city,
                    zodiac: user.user_details?.zodiac,
                    profession: user.user_details?.profession,
                    bio: user.user_details?.description || 'Sem descri√ß√£o dispon√≠vel.',
                    isOnline: isOnline,
                    isMutual: isMutual,
                    addedAt: new Date(favorite.created_at),
                    lastOnline: user.last_online_at ? new Date(user.last_online_at) : null
                };
            })
        );

        // Atualizar estat√≠sticas
        updateVipStats();
        
        // Aplicar filtro padr√£o
        applyFilter('all');
        
    } catch (error) {
        console.error('‚ùå Erro ao processar lista VIP:', error);
        showEmptyState('Erro ao carregar sua lista VIP.');
    }
}

async function checkMutualLike(userId) {
    try {
        const { data: mutualLike, error } = await supabase
            .from('user_favorites')
            .select('id')
            .eq('user_id', userId)
            .eq('favorite_user_id', currentUser.id)
            .single();

        if (error && error.code !== 'PGRST116') {
            throw error;
        }

        return !!mutualLike;
    } catch (error) {
        console.error('Erro ao verificar match m√∫tuo:', error);
        return false;
    }
}

function checkUserOnline(userProfile) {
    if (!userProfile.last_online_at) return false;
    const lastOnline = new Date(userProfile.last_online_at);
    const now = new Date();
    const minutesDiff = (now - lastOnline) / (1000 * 60);
    const isActuallyOnline = minutesDiff <= 5;
    if (userProfile.is_invisible) return false;
    return isActuallyOnline;
}

function calculateAge(birthDate) {
    if (!birthDate) return null;
    const today = new Date();
    const birth = new Date(birthDate);
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
    }
    return age;
}

// ==================== SISTEMA DE FILTROS E BUSCA ====================
function setupEventListeners() {
    // Filtros
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const filter = this.dataset.filter;
            applyFilter(filter);
        });
    });

    // Busca
    const searchInput = document.getElementById('vipSearch');
    const clearSearch = document.getElementById('clearSearch');

    searchInput.addEventListener('input', function() {
        applySearch(this.value);
    });

    clearSearch.addEventListener('click', function() {
        searchInput.value = '';
        applySearch('');
    });

    // Logout
    const logoutBtn = document.getElementById('logoutBtn');
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    
    if (logoutBtn) logoutBtn.addEventListener('click', logout);
    if (mobileLogoutBtn) mobileLogoutBtn.addEventListener('click', logout);
}

function applyFilter(filter) {
    // Atualizar bot√µes ativos
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-filter="${filter}"]`).classList.add('active');

    // Aplicar filtro
    let filtered = [...vipUsers];

    switch (filter) {
        case 'mutual':
            filtered = filtered.filter(user => user.isMutual);
            break;
        case 'online':
            filtered = filtered.filter(user => user.isOnline);
            break;
        case 'recent':
            // √öltimos 7 dias
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            filtered = filtered.filter(user => user.addedAt > oneWeekAgo);
            break;
        case 'all':
        default:
            // Todos - sem filtro
            break;
    }

    filteredUsers = filtered;
    displayVipUsers(filtered);
}

function applySearch(searchTerm) {
    if (!searchTerm.trim()) {
        // Se busca vazia, volta para o filtro atual
        const activeFilter = document.querySelector('.filter-btn.active').dataset.filter;
        applyFilter(activeFilter);
        return;
    }

    const term = searchTerm.toLowerCase().trim();
    const filtered = vipUsers.filter(user => 
        user.nickname.toLowerCase().includes(term) ||
        (user.profession && user.profession.toLowerCase().includes(term)) ||
        (user.city && user.city.toLowerCase().includes(term))
    );

    filteredUsers = filtered;
    displayVipUsers(filtered);
}

// ==================== EXIBI√á√ÉO DE USU√ÅRIOS ====================
function displayVipUsers(users) {
    const grid = document.getElementById('vipUsersGrid');
    
    if (!users || users.length === 0) {
        grid.innerHTML = `
            <div class="vip-empty-state">
                <div class="vip-empty-icon">üîç</div>
                <h3 class="vip-empty-title">Nenhum usu√°rio encontrado</h3>
                <p class="vip-empty-description">
                    Tente ajustar seus filtros ou termos de busca.
                </p>
                <button class="btn btn-primary" onclick="applyFilter('all')">
                    Mostrar Todos
                </button>
            </div>
        `;
        return;
    }

    const userCards = users.map(user => createVipUserCard(user)).join('');
    grid.innerHTML = userCards;
}

function createVipUserCard(user) {
    const mutualClass = user.isMutual ? 'mutual-match' : '';
    const onlineStatus = user.isOnline ? 'üü¢ Online' : '‚ö´ Offline';
    const lastSeen = user.lastOnline ? 
        `Visto ${formatLastSeen(user.lastOnline)}` : 'Atividade n√£o dispon√≠vel';

    return `
        <div class="vip-user-card ${mutualClass}" data-user-id="${user.id}">
            <div class="vip-user-header">
                <div class="vip-user-avatar">
                    ${user.avatar_url ? 
                        `<img src="${user.avatar_url}" alt="${user.nickname}" onerror="this.style.display='none'">` :
                        `<div style="width:100%;height:100%;background:linear-gradient(135deg,var(--vermelho-rosado),var(--lilas));border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:1.5rem;">${user.nickname.charAt(0).toUpperCase()}</div>`
                    }
                    ${user.isOnline ? '<div class="online-badge"></div>' : '<div class="offline-badge"></div>'}
                </div>
                <div class="vip-user-info">
                    <div class="vip-user-name">
                        ${user.nickname}${user.age ? `, ${user.age}` : ''}
                        ${user.isMutual ? 'üíù' : ''}
                    </div>
                    <div class="vip-user-details">
                        <div>${onlineStatus}</div>
                        ${user.city ? `<div>üìç ${user.city}</div>` : ''}
                        ${user.profession ? `<div>üíº ${user.profession}</div>` : ''}
                    </div>
                </div>
            </div>
            
            <div class="vip-user-bio">${user.bio}</div>
            
            <div class="vip-user-actions">
                <button class="vip-action-btn primary" onclick="sendMessage('${user.id}')">
                    üíå Mensagem
                </button>
                <button class="vip-action-btn secondary" onclick="viewProfile('${user.id}')">
                    üëÄ Ver Perfil
                </button>
                <button class="vip-action-btn danger" onclick="openRemoveFavoriteModal('${user.id}', '${user.nickname}')">
                    ‚ùå Remover
                </button>
            </div>
        </div>
    `;
}

function formatLastSeen(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / (1000 * 60));
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffMins < 60) {
        return `h√° ${diffMins} min`;
    } else if (diffHours < 24) {
        return `h√° ${diffHours} h`;
    } else if (diffDays === 1) {
        return 'ontem';
    } else {
        return `h√° ${diffDays} dias`;
    }
}

// ==================== ATUALIZA√á√ÉO DE ESTAT√çSTICAS ====================
function updateVipStats() {
    const total = vipUsers.length;
    const mutual = vipUsers.filter(user => user.isMutual).length;
    const online = vipUsers.filter(user => user.isOnline).length;
    const recent = vipUsers.filter(user => {
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
        return user.addedAt > oneWeekAgo;
    }).length;

    // Atualizar n√∫meros
    document.getElementById('totalFavorites').textContent = total;
    document.getElementById('mutualMatches').textContent = mutual;
    document.getElementById('onlineNow').textContent = online;

    // Atualizar contadores dos filtros
    document.getElementById('countAll').textContent = total;
    document.getElementById('countMutual').textContent = mutual;
    document.getElementById('countOnline').textContent = online;
    document.getElementById('countRecent').textContent = recent;
}

// ==================== REMO√á√ÉO DE FAVORITOS ====================
function openRemoveFavoriteModal(userId, userName) {
    currentRemoveUserId = userId;
    currentRemoveUserName = userName;
    
    document.getElementById('removeUserName').textContent = userName;
    document.getElementById('removeFavoriteModal').classList.add('show');
}

function closeRemoveFavoriteModal() {
    document.getElementById('removeFavoriteModal').classList.remove('show');
    currentRemoveUserId = null;
    currentRemoveUserName = null;
}

async function confirmRemoveFavorite() {
    if (!currentRemoveUserId) return;

    const confirmBtn = document.getElementById('confirmRemoveBtn');
    const originalText = confirmBtn.innerHTML;

    try {
        confirmBtn.innerHTML = '‚è≥ Removendo...';
        confirmBtn.disabled = true;

        const { error } = await supabase
            .from('user_favorites')
            .delete()
            .eq('user_id', currentUser.id)
            .eq('favorite_user_id', currentRemoveUserId);

        if (error) throw error;

        // Remover da lista local
        vipUsers = vipUsers.filter(user => user.id !== currentRemoveUserId);
        
        // Atualizar UI
        updateVipStats();
        applyFilter(document.querySelector('.filter-btn.active').dataset.filter);
        
        showQuickToast(`‚úÖ ${currentRemoveUserName} removido da Lista VIP`);
        closeRemoveFavoriteModal();

    } catch (error) {
        console.error('‚ùå Erro ao remover favorito:', error);
        showQuickToast('‚ùå Erro ao remover da lista VIP');
    } finally {
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    }
}

// ==================== ESTADOS DA UI ====================
function showEmptyState(message = 'Sua Lista VIP est√° vazia.') {
    const grid = document.getElementById('vipUsersGrid');
    grid.innerHTML = `
        <div class="vip-empty-state">
            <div class="vip-empty-icon">‚≠ê</div>
            <h3 class="vip-empty-title">${message}</h3>
            <p class="vip-empty-description">
                Comece curtindo perfis que voc√™ gosta para adicion√°-los aqui!
            </p>
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 2rem;">
                <a href="home.html" class="btn btn-primary">
                    üè† Voltar para Home
                </a>
                <a href="busca.html" class="btn btn-premium">
                    üîç Buscar Pessoas
                </a>
            </div>
        </div>
    `;

    // Zerar estat√≠sticas
    document.getElementById('totalFavorites').textContent = '0';
    document.getElementById('mutualMatches').textContent = '0';
    document.getElementById('onlineNow').textContent = '0';
    
    document.querySelectorAll('.filter-count').forEach(count => {
        count.textContent = '0';
    });
}

function showPremiumRequiredModal() {
    const grid = document.getElementById('vipUsersGrid');
    grid.innerHTML = `
        <div class="vip-empty-state">
            <div class="vip-empty-icon">üîí</div>
            <h3 class="vip-empty-title">Recurso Exclusivo Premium</h3>
            <p class="vip-empty-description">
                A Lista VIP est√° dispon√≠vel apenas para usu√°rios Premium.
                Atualize seu plano para acessar esta funcionalidade exclusiva!
            </p>
            <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-top: 2rem;">
                <a href="princing.html" class="btn btn-premium" style="padding: 1rem 2rem;">
                    üíé Tornar-se Premium
                </a>
                <a href="home.html" class="btn btn-secondary">
                    üè† Voltar para Home
                </a>
            </div>
        </div>
    `;
}

// ==================== INTERA√á√ïES ====================
async function sendMessage(userId) {
    console.log('üíå Enviando mensagem para:', userId);
    
    if (!isProfileComplete()) {
        showQuickToast('Complete seu perfil primeiro!');
        window.location.href = 'painel.html';
        return;
    }
    
    localStorage.setItem('openChatWithUserId', userId);
    window.location.href = 'mensagens.html';
}

async function viewProfile(userId) {
    console.log('üëÄ Visualizando perfil:', userId);
    
    if (!isProfileComplete()) {
        showQuickToast('Complete seu perfil primeiro!');
        window.location.href = 'painel.html';
        return;
    }
    
    if (window.registrarVisitaPerfil) {
        await window.registrarVisitaPerfil(userId);
    }
    
    localStorage.setItem('viewingProfileId', userId);
    window.location.href = 'perfil.html';
}

function isProfileComplete() {
    return userProfile && userProfile.full_name && userProfile.full_name.trim() !== '' && userProfile.birth_date;
}

// ==================== UTILIT√ÅRIOS ====================
async function logout() {
    try {
        await supabase.auth.signOut();
        window.location.href = 'index.html';
    } catch (error) {
        console.error('Erro ao fazer logout:', error);
    }
}

function showQuickToast(message) {
    document.querySelectorAll('.quick-toast').forEach(toast => toast.remove());
    
    const toast = document.createElement('div');
    toast.className = 'quick-toast';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
        background: #38a169; color: white; padding: 12px 20px; border-radius: 25px;
        font-size: 14px; font-weight: 600; z-index: 10000; opacity: 0;
        transition: opacity 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        text-align: center; min-width: 200px; max-width: 90%;
    `;
    
    document.body.appendChild(toast);
    setTimeout(() => toast.style.opacity = '1', 100);
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function setupMobileMenu() {
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const mobileMenu = document.getElementById('mobileMenu');
    const closeMobileMenu = document.getElementById('closeMobileMenu');

    if (!hamburgerBtn || !mobileMenu) {
        console.warn('‚ö†Ô∏è Elementos do menu mobile n√£o encontrados');
        return;
    }

    hamburgerBtn.addEventListener('click', () => {
        mobileMenu.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    });

    closeMobileMenu.addEventListener('click', () => {
        mobileMenu.style.display = 'none';
        document.body.style.overflow = 'auto';
    });

    mobileMenu.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
            mobileMenu.style.display = 'none';
            document.body.style.overflow = 'auto';
        });
    });

    function checkScreenSize() {
        const userMenu = document.querySelector('.user-menu');
        if (!userMenu) return;
        
        if (window.innerWidth <= 768) {
            userMenu.style.display = 'none';
            if (hamburgerBtn) hamburgerBtn.style.display = 'flex';
        } else {
            userMenu.style.display = 'flex';
            if (hamburgerBtn) hamburgerBtn.style.display = 'none';
            mobileMenu.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
    }

    window.addEventListener('resize', checkScreenSize);
    window.addEventListener('load', checkScreenSize);
    checkScreenSize();
}

function openSupportModal() {
    alert('üìû Entre em contato com nosso suporte: suporte@amorconect.com');
}

// ==================== FUN√á√ïES GLOBAIS ====================
window.sendMessage = sendMessage;
window.viewProfile = viewProfile;
window.openRemoveFavoriteModal = openRemoveFavoriteModal;
window.closeRemoveFavoriteModal = closeRemoveFavoriteModal;
window.confirmRemoveFavorite = confirmRemoveFavorite;
window.applyFilter = applyFilter;
window.openSupportModal = openSupportModal;

console.log('‚úÖ LISTA-VIP.HTML CARREGADA COM SUCESSO! üéâ');
  </script>
</body>
</html>